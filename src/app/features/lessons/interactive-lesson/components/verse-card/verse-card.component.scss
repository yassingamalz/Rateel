@use "sass:map";
@use 'variables' as vars;

:host {
  display: block;
  transform: translateZ(0);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

.verse-card {
  flex: 0 0 auto;
  width: min(80vw, 700px);
  margin: 0 20px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  z-index: 1;
  transform: translateZ(0);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;

  // Frame corners - common structure
  .frame-corner {
    position: absolute;
    width: 30px;
    height: 30px;

    &::before, &::after {
      content: '';
      position: absolute;
      background-color: rgba(0, 0, 0, 0.2) !important; // Force darker color for all corners
    }

    &::before {
      width: 100%;
      height: 1px;
    }

    &::after {
      width: 1px;
      height: 100%;
    }

    &--tl {
      top: 10px;
      left: 10px;
      
      &::before { 
        top: 0; 
        left: 0; 
      }
      
      &::after { 
        top: 0; 
        left: 0; 
      }
    }

    &--tr {
      top: 10px;
      right: 10px;
      
      &::before { 
        top: 0; 
        right: 0; 
      }
      
      &::after { 
        top: 0; 
        right: 0; 
      }
    }

    &--bl {
      bottom: 10px;
      left: 10px;
      
      &::before { 
        bottom: 0; 
        left: 0; 
      }
      
      &::after { 
        bottom: 0; 
        left: 0; 
      }
    }

    &--br {
      bottom: 10px;
      right: 10px;
      
      &::before { 
        bottom: 0; 
        right: 0; 
      }
      
      &::after { 
        bottom: 0; 
        right: 0; 
      }
    }
  }

  // Common styles
  .verse-frame {
    position: relative;
    border-radius: 20px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: all 0.3s ease;
    transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    will-change: transform;
  }

  .verse-number {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .verse-text-container {
    width: 100%;
    text-align: center;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
  }

  .verse-text {
    font-family: 'UthmanicHafs', 'me_quran', serif;
    font-size: 2.5rem;
    line-height: 2;
    text-align: center;
    direction: rtl;
    
    // Critical text rendering enhancements
    transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    will-change: transform;
    text-rendering: optimizeLegibility;

    .word {
      display: inline-block;
      margin: 0 0.12em;
      transition: all 0.3s ease;
      position: relative;

      &.highlight {
        position: relative;

        &::after {
          content: '';
          position: absolute;
          left: 0;
          right: 0;
          bottom: 0;
          height: 2px;
          background: currentColor;
          border-radius: 1px;
          opacity: 0.7;
        }
      }
    }
  }

  .word-progress {
    margin-top: 20px;
    width: 100%;

    .word-dots {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      padding: 0 10px;

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }
    }
  }

  .verse-glow {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 0.5s ease;
    filter: blur(20px);
    z-index: -1;
  }
}

// Dark theme (default)
:host-context(.theme-dark), :host {
  .verse-card {
    &.active {
      z-index: 2;
      transform: scale(1.05);

      .verse-frame {
        background: rgba(map-get(vars.$colors, 'primary', 'light'), 0.2);
        box-shadow:
          0 12px 30px rgba(0, 0, 0, 0.2),
          0 0 20px rgba(map-get(vars.$colors, 'accent', 'base'), 0.2);
        border: 1px solid rgba(map-get(vars.$colors, 'accent', 'base'), 0.3);
      }

      .verse-glow {
        opacity: 0.6;
      }

      .verse-text {
        color: white;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
    }

    &.completed {
      .verse-frame {
        background: rgba(map-get(vars.$colors, 'accent', 'base'), 0.15);
        border: 1px solid rgba(map-get(vars.$colors, 'accent', 'base'), 0.2);
      }

      .verse-number {
        background: map-get(vars.$colors, 'accent', 'base');
        color: map-get(vars.$colors, 'primary', 'dark');
      }

      .verse-glow {
        opacity: 0.4;
      }
    }

    &.inactive {
      filter: brightness(0.7) saturate(0.8);

      .verse-frame {
        background: rgba(map-get(vars.$colors, 'primary', 'base'), 0.2);
      }

      .verse-text {
        opacity: 0.7;
      }
    }

    .verse-frame {
      padding: 40px 30px;
      background: rgba(map-get(vars.$colors, 'primary', 'base'), 0.3);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .verse-number {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .verse-text {
      color: map-get(vars.$colors, 'text', 'light');

      .word {
        &.current-word {
          color: map-get(vars.$colors, 'accent', 'light');
          transform: scale(1.1);
          text-shadow: 0 0 10px rgba(map-get(vars.$colors, 'accent', 'base'), 0.5);
        }

        &.spoken {
          color: rgba(white, 0.7);
        }
      }
    }

    .word-progress {
      .word-dots {
        .dot {
          background: rgba(255, 255, 255, 0.2);

          &.completed {
            background: map-get(vars.$colors, 'accent', 'base');
          }

          &.current {
            transform: scale(1.3);
            background: map-get(vars.$colors, 'accent', 'light');
            box-shadow: 0 0 8px rgba(map-get(vars.$colors, 'accent', 'base'), 0.5);
          }
        }
      }
    }
  }
}

// Light theme (Mushaf style)
:host-context(.theme-light) {
  .verse-card {
    &.active {
      z-index: 2;
      transform: scale(1.05);

      .verse-frame {
        background-color: #F8F3E6 !important;
        box-shadow:
          0 12px 30px rgba(0, 0, 0, 0.15),
          inset 0 0 0 1px rgba(196, 164, 132, 0.3) !important;
      }
    }

    &.completed {
      .verse-frame {
        background-color: #F8F3E6 !important;
      }

      .verse-number {
        background-color: #C4A484 !important;
        color: white !important;
      }
    }

    &.inactive {
      .verse-frame {
        background-color: #F8F3E6 !important;
        opacity: 0.8;
      }
    }

    .verse-frame {
      padding: 3rem 2.5rem;
      border-radius: 12px;
      background-color: #F8F3E6 !important;
      box-shadow:
        0 8px 20px rgba(0, 0, 0, 0.15) ,
        inset 0 0 0 1px rgba(196, 164, 132, 0.2) !important;
    }

    .verse-number {
      background-color: rgba(196, 164, 132, 0.15) !important;
      color: #1A0F00 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1) !important;
    }

    .verse-text {
      color: #1A0F00 !important;
      text-shadow: none !important;

      .word {
        &.current-word {
          color: #A67C52 !important;
          transform: scale(1.1);
          text-shadow: 0 0 1px rgba(0, 0, 0, 0.1) !important;
        }

        &.spoken {
          color: #A67C52 !important;
          opacity: 0.5;
        }
      }
    }

    .word-progress {
      .word-dots {
        .dot {
          background-color: rgba(196, 164, 132, 0.2) !important;

          &.completed {
            background-color: #C4A484 !important;
          }

          &.current {
            transform: scale(1.3);
            background-color: #A67C52 !important;
            box-shadow: 0 0 8px rgba(196, 164, 132, 0.3) !important;
          }
        }
      }
    }
  }
}

// Media queries - mobile adjustments
@media (max-width: 768px) {
  .verse-card {
    width: 90vw !important;

    .verse-text {
      font-size: 2rem !important;
    }
  }
  
  :host-context(.theme-dark), :host {
    .verse-card .verse-frame {
      padding: 30px 20px !important;
    }
  }
  
  :host-context(.theme-light) {
    .verse-card .verse-frame {
      padding: 2.5rem 1.5rem !important;
    }
  }
}

// Mobile landscape optimizations
@media (orientation: landscape) and (max-height: 600px) {
  .verse-card {
    width: 70vw !important;

    .verse-text {
      font-size: 1.75rem !important;
      line-height: 1.8 !important;
    }

    .word-progress {
      margin-top: 10px !important;
    }
  }
  
  :host-context(.theme-dark), :host {
    .verse-card .verse-frame {
      padding: 25px 20px !important;
    }
  }
  
  :host-context(.theme-light) {
    .verse-card .verse-frame {
      padding: 2rem 1.5rem !important;
    }
  }
}